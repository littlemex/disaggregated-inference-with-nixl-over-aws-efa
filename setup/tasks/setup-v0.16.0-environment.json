{
  "name": "Environment Setup for vLLM v0.16.0 + NIXL",
  "description": "Comprehensive environment setup on DLAMI: vLLM v0.16.0, NIXL v0.10.0, NCCL tests, Docker, and verification",
  "variables": {
    "VLLM_VERSION": "0.16.0",
    "NIXL_VERSION": "0.10.0",
    "NCCL_TESTS_DIR": "/opt/nccl-tests",
    "ETCD_VERSION": "v3.5.9",
    "ETCD_PORT": "2379"
  },
  "tasks": [
    {
      "id": "01-verify-gpu",
      "name": "Verify GPU and NVIDIA Driver",
      "description": "Verify NVIDIA GPU and driver are available (pre-installed in DLAMI)",
      "skip_if": "nvidia-smi >/dev/null 2>&1",
      "commands": [
        "echo '[ERROR] NVIDIA driver not found. This script requires DLAMI with GPU support.'",
        "exit 1"
      ]
    },
    {
      "id": "02-verify-efa",
      "name": "Verify EFA Device",
      "description": "Verify EFA device and libfabric tools are available (pre-installed in DLAMI)",
      "skip_if": "test -e /dev/infiniband/uverbs0 && test -x /opt/amazon/efa/bin/fi_info",
      "commands": [
        "echo '[ERROR] EFA device or libfabric tools not found. Verify EFA is enabled on this instance.'",
        "exit 1"
      ]
    },
    {
      "id": "03-upgrade-pip",
      "name": "Upgrade pip and setuptools",
      "description": "Upgrade pip and setuptools to latest versions for better dependency resolution",
      "commands": [
        "python3 -m pip install --upgrade pip setuptools wheel -q",
        "echo '[OK] pip upgraded: $(python3 -m pip --version)'"
      ]
    },
    {
      "id": "04-install-vllm",
      "name": "Install vLLM v0.16.0",
      "description": "Install vLLM v0.16.0 inference engine",
      "skip_if": "python3 -c 'import vllm; exit(0 if vllm.__version__ == \"{{VLLM_VERSION}}\" else 1)' 2>/dev/null",
      "commands": [
        "echo '[INFO] Installing vLLM {{VLLM_VERSION}}...'",
        "python3 -m pip install --no-cache-dir 'vllm=={{VLLM_VERSION}}' --retries 3 -q",
        "python3 -c 'import vllm; print(f\"[OK] vLLM installed: {vllm.__version__}\")'"
      ]
    },
    {
      "id": "05-install-nixl",
      "name": "Install NIXL (nixl[cu12])",
      "description": "Install NIXL library with CUDA 12 support (includes nixlbench, kvbench)",
      "skip_if": "python3 -c 'import nixl' 2>/dev/null",
      "commands": [
        "echo '[INFO] Installing NIXL with CUDA 12 support...'",
        "python3 -m pip install --no-cache-dir 'nixl[cu12]' --retries 3 -q",
        "python3 -c 'import nixl; print(\"[OK] NIXL installed\")'",
        "command -v nixlbench >/dev/null 2>&1 && echo '[OK] nixlbench available in PATH' || echo '[INFO] nixlbench not in PATH (may need to locate binary)'"
      ]
    },
    {
      "id": "06-install-mlflow-deps",
      "name": "Install MLflow Dependencies",
      "description": "Install sagemaker-mlflow and boto3 for MLflow integration",
      "skip_if": "python3 -c 'import sagemaker_mlflow, boto3' 2>/dev/null",
      "commands": [
        "echo '[INFO] Installing MLflow dependencies...'",
        "python3 -m pip install --no-cache-dir sagemaker-mlflow boto3 --retries 3 -q",
        "python3 -c 'import mlflow; print(f\"[OK] MLflow: {mlflow.__version__}\")'"
      ]
    },
    {
      "id": "07-install-analysis-deps",
      "name": "Install Analysis Dependencies",
      "description": "Install pandas, numpy, scipy for analysis scripts",
      "skip_if": "python3 -c 'import pandas, numpy, scipy' 2>/dev/null",
      "commands": [
        "echo '[INFO] Installing analysis dependencies...'",
        "python3 -m pip install --no-cache-dir pandas numpy scipy --retries 3 -q",
        "echo '[OK] Analysis dependencies installed'"
      ]
    },
    {
      "id": "08-setup-nccl-tests",
      "name": "Build NCCL Tests",
      "description": "Install NCCL library and build NCCL tests for GPU communication benchmarking",
      "skip_if": "test -f {{NCCL_TESTS_DIR}}/build/all_reduce_perf",
      "commands": [
        "echo '[INFO] Setting up NCCL tests (this may take a few minutes)...'",
        "sudo bash setup-nccl-tests.sh 2>&1 | grep -E '(STEP|INFO|SUCCESS|ERROR)' || true",
        "test -f {{NCCL_TESTS_DIR}}/build/all_reduce_perf && echo '[OK] NCCL tests setup complete' || { echo '[ERROR] NCCL tests setup failed'; exit 1; }"
      ]
    },
    {
      "id": "09-setup-docker",
      "name": "Setup Docker for etcd",
      "description": "Ensure Docker is running (required for etcd container in nixlbench)",
      "skip_if": "docker ps >/dev/null 2>&1",
      "commands": [
        "echo '[INFO] Checking Docker installation...'",
        "if ! command -v docker >/dev/null 2>&1; then echo '[INFO] Installing Docker...'; curl -fsSL https://get.docker.com | sudo sh; sudo usermod -aG docker ubuntu; fi",
        "sudo systemctl start docker 2>/dev/null || sudo service docker start 2>/dev/null || true",
        "sleep 3",
        "docker ps >/dev/null 2>&1 && echo '[OK] Docker is running' || { echo '[WARNING] Docker not running. You may need to logout and login again for group changes.'; exit 0; }"
      ]
    },
    {
      "id": "10-setup-etcd",
      "name": "Setup etcd Container",
      "description": "Start etcd container for nixlbench distributed coordination",
      "skip_if": "docker ps --filter name=etcd-nixlbench --format '{{.Names}}' | grep -q etcd-nixlbench",
      "commands": [
        "echo '[INFO] Starting etcd container...'",
        "docker rm -f etcd-nixlbench 2>/dev/null || true",
        "docker run -d --name etcd-nixlbench --network host quay.io/coreos/etcd:{{ETCD_VERSION}} /usr/local/bin/etcd --listen-client-urls=http://0.0.0.0:{{ETCD_PORT}} --advertise-client-urls=http://0.0.0.0:{{ETCD_PORT}}",
        "sleep 2",
        "docker ps --filter name=etcd-nixlbench --format '{{.Names}}' | grep -q etcd-nixlbench && echo '[OK] etcd container running' || { echo '[WARNING] etcd container not running'; exit 0; }"
      ]
    },
    {
      "id": "11-verify-environment",
      "name": "Verify Complete Environment",
      "description": "Comprehensive verification of all installed components",
      "commands": [
        "echo '=========================================='",
        "echo 'Environment Verification'",
        "echo '=========================================='",
        "echo ''",
        "echo '[1/8] Python and pip'",
        "python3 --version",
        "python3 -m pip --version",
        "echo ''",
        "echo '[2/8] vLLM'",
        "python3 -c 'import vllm; assert vllm.__version__ == \"{{VLLM_VERSION}}\", f\"Expected {{VLLM_VERSION}}, got {vllm.__version__}\"; print(f\"  vLLM: {vllm.__version__} [OK]\")'",
        "echo ''",
        "echo '[3/8] NIXL'",
        "python3 -c 'import nixl; print(\"  NIXL: installed [OK]\")'",
        "echo ''",
        "echo '[4/8] MLflow'",
        "python3 -c 'import mlflow, sagemaker_mlflow, boto3; print(f\"  MLflow: {mlflow.__version__} [OK]\")'",
        "echo ''",
        "echo '[5/8] Analysis libraries'",
        "python3 -c 'import pandas, numpy, scipy; print(\"  pandas, numpy, scipy [OK]\")'",
        "echo ''",
        "echo '[6/8] GPU and NVIDIA Driver'",
        "nvidia-smi --query-gpu=name,driver_version,memory.total --format=csv,noheader | head -1 | awk '{print \"  GPU: \"$0\" [OK]\"}'",
        "echo ''",
        "echo '[7/8] EFA Device'",
        "test -e /dev/infiniband/uverbs0 && echo '  EFA device: /dev/infiniband/uverbs0 [OK]' || echo '  EFA device: NOT FOUND [FAIL]'",
        "/opt/amazon/efa/bin/fi_info -p efa 2>/dev/null | grep -q 'provider: efa' && echo '  libfabric EFA provider: [OK]' || echo '  libfabric EFA provider: [FAIL]'",
        "echo ''",
        "echo '[8/8] NCCL Tests'",
        "test -f {{NCCL_TESTS_DIR}}/build/all_reduce_perf && echo '  NCCL all_reduce_perf: [OK]' || echo '  NCCL tests: NOT FOUND [FAIL]'",
        "echo ''",
        "echo '=========================================='",
        "echo 'Environment setup complete!'",
        "echo 'Ready for disaggregated inference experiments.'",
        "echo '=========================================='",
        "echo ''",
        "echo 'Next steps:'",
        "echo '  1. Generate task definitions: cd experiments && ./generate_tasks.py phase1'",
        "echo '  2. Deploy scripts: ./run_experiment.sh phase1 deploy'",
        "echo '  3. Run experiments: ./run_experiment.sh phase1 run L0'",
        "echo ''"
      ]
    }
  ]
}
