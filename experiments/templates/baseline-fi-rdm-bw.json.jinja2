{# baseline-fi-rdm-bw.json.jinja2 - EFA RDMA 帯域幅測定テンプレート #}
{# 変数: PHASE, PATTERN_ID, OUTPUT_DIR, TIMESTAMP, NODE_ROLE, PEER_IP #}
{# ノード: Server = Node2, Client = Node1 #}
{# ツール: ib_write_bw (perftest package) #}
{
  "name": "L0-Baseline: ib_write_bw - EFA RDMA Bandwidth ({{ node_role | default('client') }})",
  "description": "EFA RDMA 帯域幅の測定 ({{ node_role | default('client') }} side)",
  "variables": {
    "PHASE": "{{ phase }}",
    "PATTERN_ID": "{{ pattern_id }}",
    "OUTPUT_DIR": "{{ output_dir | default('/tmp/results') }}",
    "OUTPUT_FILE": "{{ output_dir | default('/tmp/results') }}/{{ pattern_id }}.json",
    "TIMESTAMP": "{{ timestamp }}",
    "NODE_ROLE": "{{ node_role | default('client') }}",
    "PEER_IP": "{{ peer_ip | default('') }}"
  },
  "tasks": [
    {
      "id": "01-verify-tools",
      "name": "Verify ib_write_bw availability",
      "commands": [
        "echo '[INFO] Checking for ib_write_bw (perftest)...'",
        "mkdir -p {{"{{"}}OUTPUT_DIR{{"}}"}}",
        "if ! command -v ib_write_bw >/dev/null 2>&1; then echo '[WARNING] ib_write_bw not found'; fi",
        "echo '[OK] Tool verification complete'"
      ]
    },
{% if node_role == 'server' %}
    {
      "id": "02-run-measurement",
      "name": "Run ib_write_bw server (wait for client connection)",
      "commands": [
        "echo '[INFO] Starting ib_write_bw server...'",
        "if command -v ib_write_bw >/dev/null 2>&1; then timeout 120 ib_write_bw -d rdmap49s0 -F 2>&1 | tee /tmp/ib_write_bw_raw.txt || echo '[WARNING] ib_write_bw server exited'; else echo '[SKIP] ib_write_bw not available' > /tmp/ib_write_bw_raw.txt; fi",
        "echo '[OK] ib_write_bw server completed'"
      ]
    },
{% else %}
    {
      "id": "02-run-measurement",
      "name": "Run ib_write_bw client (connect to server)",
      "commands": [
        "echo '[INFO] Starting ib_write_bw client connecting to {{"{{"}}PEER_IP{{"}}"}}...'",
        "echo '[INFO] Waiting 5 seconds for server to be ready...'",
        "sleep 5",
        "if command -v ib_write_bw >/dev/null 2>&1 && [ -n '{{"{{"}}PEER_IP{{"}}"}}' ]; then ib_write_bw -d rdmap49s0 -F {{"{{"}}PEER_IP{{"}}"}} 2>&1 | tee /tmp/ib_write_bw_raw.txt || echo '[WARNING] ib_write_bw client exited with error'; else echo '[SKIP] ib_write_bw not available or PEER_IP not set' > /tmp/ib_write_bw_raw.txt; fi",
        "echo '[OK] ib_write_bw client completed'"
      ]
    },
{% endif %}
    {
      "id": "03-collect-results",
      "name": "Collect bandwidth results into JSON",
      "commands": [
        "echo '[INFO] Collecting results into {{"{{"}}OUTPUT_FILE{{"}}"}}...'",
        "python3 /tmp/scripts/collect_ib_write_bw.py --pattern-id {{"{{"}}PATTERN_ID{{"}}"}} --phase {{"{{"}}PHASE{{"}}"}} --timestamp {{"{{"}}TIMESTAMP{{"}}"}} --output {{"{{"}}OUTPUT_FILE{{"}}"}} --node-role {{"{{"}}NODE_ROLE{{"}}"}} --peer-ip '{{"{{"}}PEER_IP{{"}}"}}'",
        "echo '[OK] ib_write_bw baseline measurement complete'"
      ]
    }
  ]
}
