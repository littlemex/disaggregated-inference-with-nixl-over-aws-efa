{# baseline-fi-rdm-bw.json.jinja2 - EFA RDMA 帯域幅測定テンプレート #}
{# 変数: PHASE, PATTERN_ID, OUTPUT_DIR, TIMESTAMP, NODE_ROLE, PEER_IP #}
{# ノード: Server = Node2, Client = Node1 #}
{
  "name": "L0-Baseline: fi_rdm_bw - EFA RDMA Bandwidth ({{ node_role | default('client') }})",
  "description": "EFA RDMA 帯域幅の測定 ({{ node_role | default('client') }} side)",
  "variables": {
    "PHASE": "{{ phase }}",
    "PATTERN_ID": "{{ pattern_id }}",
    "OUTPUT_DIR": "{{ output_dir | default('/tmp/results') }}",
    "OUTPUT_FILE": "{{ output_dir | default('/tmp/results') }}/{{ pattern_id }}.json",
    "TIMESTAMP": "{{ timestamp }}",
    "NODE_ROLE": "{{ node_role | default('client') }}",
    "PEER_IP": "{{ peer_ip | default('') }}"
  },
  "tasks": [
    {
      "id": "01-verify-tools",
      "name": "Verify fi_rdm_bw availability",
      "commands": [
        "echo '[INFO] Checking for fi_rdm_bw...'",
        "mkdir -p {{"{{"}}OUTPUT_DIR{{"}}"}}",
        "if ! command -v fi_rdm_bw >/dev/null 2>&1; then echo '[WARNING] fi_rdm_bw not found'; fi",
        "echo '[OK] Tool verification complete'"
      ]
    },
{% if node_role == 'server' %}
    {
      "id": "02-run-measurement",
      "name": "Run fi_rdm_bw server (wait for client connection)",
      "commands": [
        "echo '[INFO] Starting fi_rdm_bw server...'",
        "if command -v fi_rdm_bw >/dev/null 2>&1; then timeout 120 fi_rdm_bw -p efa 2>&1 | tee /tmp/fi_rdm_bw_raw.txt || echo '[WARNING] fi_rdm_bw server exited'; else echo '[SKIP] fi_rdm_bw not available' > /tmp/fi_rdm_bw_raw.txt; fi",
        "echo '[OK] fi_rdm_bw server completed'"
      ]
    },
{% else %}
    {
      "id": "02-run-measurement",
      "name": "Run fi_rdm_bw client (connect to server)",
      "commands": [
        "echo '[INFO] Starting fi_rdm_bw client connecting to {{"{{"}}PEER_IP{{"}}"}}...'",
        "echo '[INFO] Waiting 5 seconds for server to be ready...'",
        "sleep 5",
        "if command -v fi_rdm_bw >/dev/null 2>&1 && [ -n '{{"{{"}}PEER_IP{{"}}"}}' ]; then fi_rdm_bw -p efa {{"{{"}}PEER_IP{{"}}"}} 2>&1 | tee /tmp/fi_rdm_bw_raw.txt || echo '[WARNING] fi_rdm_bw client exited with error'; else echo '[SKIP] fi_rdm_bw not available or PEER_IP not set' > /tmp/fi_rdm_bw_raw.txt; fi",
        "echo '[OK] fi_rdm_bw client completed'"
      ]
    },
{% endif %}
    {
      "id": "03-collect-results",
      "name": "Collect bandwidth results into JSON",
      "commands": [
        "echo '[INFO] Collecting results into {{"{{"}}OUTPUT_FILE{{"}}"}}...'",
        "python3 /tmp/scripts/collect_fi_rdm_bw.py --pattern-id {{"{{"}}PATTERN_ID{{"}}"}} --phase {{"{{"}}PHASE{{"}}"}} --timestamp {{"{{"}}TIMESTAMP{{"}}"}} --output {{"{{"}}OUTPUT_FILE{{"}}"}} --node-role {{"{{"}}NODE_ROLE{{"}}"}} --peer-ip '{{"{{"}}PEER_IP{{"}}"}}'",
        "echo '[OK] fi_rdm_bw baseline measurement complete'"
      ]
    }
  ]
}
