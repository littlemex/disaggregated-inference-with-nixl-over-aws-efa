{# baseline-fi-rdm-pingpong.json.jinja2 - EFA レイテンシ測定テンプレート #}
{# 変数: PHASE, PATTERN_ID, OUTPUT_DIR, TIMESTAMP, NODE_ROLE, PEER_IP #}
{# ノード: Server = Node2, Client = Node1 #}
{# 測定サイズ: 64, 1024, 65536, 1048576 bytes #}
{# ツール: ib_write_lat (perftest package) #}
{
  "name": "L0-Baseline: ib_write_lat - EFA Latency ({{ node_role | default('client') }})",
  "description": "EFA レイテンシの測定 ({{ node_role | default('client') }} side, 複数メッセージサイズ)",
  "variables": {
    "PHASE": "{{ phase }}",
    "PATTERN_ID": "{{ pattern_id }}",
    "OUTPUT_DIR": "{{ output_dir | default('/tmp/results') }}",
    "OUTPUT_FILE": "{{ output_dir | default('/tmp/results') }}/{{ pattern_id }}.json",
    "TIMESTAMP": "{{ timestamp }}",
    "NODE_ROLE": "{{ node_role | default('client') }}",
    "PEER_IP": "{{ peer_ip | default('') }}"
  },
  "tasks": [
    {
      "id": "01-verify-tools",
      "name": "Verify ib_write_lat availability",
      "commands": [
        "echo '[INFO] Checking for ib_write_lat (perftest)...'",
        "mkdir -p {{"{{"}}OUTPUT_DIR{{"}}"}}",
        "if ! command -v ib_write_lat >/dev/null 2>&1; then echo '[WARNING] ib_write_lat not found'; fi",
        "echo '[OK] Tool verification complete'"
      ]
    },
{% if node_role == 'server' %}
    {
      "id": "02-run-pingpong-64",
      "name": "Run ib_write_lat server (size=64)",
      "commands": [
        "echo '[INFO] Starting ib_write_lat server (size=64)...'",
        "if command -v ib_write_lat >/dev/null 2>&1; then timeout 60 ib_write_lat -d rdmap49s0 -s 64 -F 2>-s64 2>&11 | tee /tmp/pingpong_64_raw.txt || echo '[WARNING] pingpong server exited'; else echo '[SKIP] ib_write_lat not available' > /tmp/pingpong_64_raw.txt; fi"
      ]
    },
    {
      "id": "03-run-pingpong-1k",
      "name": "Run ib_write_lat server (size=1024)",
      "commands": [
        "echo '[INFO] Starting ib_write_lat server (size=1024)...'",
        "if command -v ib_write_lat >/dev/null 2>&1; then timeout 60 ib_write_lat -d rdmap49s0 -s 1024 -F 2>-s1024 2>&11 | tee /tmp/pingpong_1k_raw.txt || echo '[WARNING] pingpong server exited'; else echo '[SKIP]' > /tmp/pingpong_1k_raw.txt; fi"
      ]
    },
    {
      "id": "04-run-pingpong-64k",
      "name": "Run ib_write_lat server (size=65536)",
      "commands": [
        "echo '[INFO] Starting ib_write_lat server (size=65536)...'",
        "if command -v ib_write_lat >/dev/null 2>&1; then timeout 60 ib_write_lat -d rdmap49s0 -s 65536 -F 2>-s65536 2>&11 | tee /tmp/pingpong_64k_raw.txt || echo '[WARNING] pingpong server exited'; else echo '[SKIP]' > /tmp/pingpong_64k_raw.txt; fi"
      ]
    },
    {
      "id": "05-run-pingpong-1m",
      "name": "Run ib_write_lat server (size=1048576)",
      "commands": [
        "echo '[INFO] Starting ib_write_lat server (size=1048576)...'",
        "if command -v ib_write_lat >/dev/null 2>&1; then timeout 60 ib_write_lat -d rdmap49s0 -s 1048576 -F 2>-s1048576 2>&11 | tee /tmp/pingpong_1m_raw.txt || echo '[WARNING] pingpong server exited'; else echo '[SKIP]' > /tmp/pingpong_1m_raw.txt; fi"
      ]
    },
{% else %}
    {
      "id": "02-run-pingpong-64",
      "name": "Run ib_write_lat client (size=64)",
      "commands": [
        "echo '[INFO] Starting ib_write_lat client (size=64) connecting to {{"{{"}}PEER_IP{{"}}"}}...'",
        "sleep 3",
        "if command -v ib_write_lat >/dev/null 2>&1 && [ -n '{{"{{"}}PEER_IP{{"}}"}}' ]; then ib_write_lat -d rdmap49s0 -s 64 -F {{"{{"}}PEER_IP{{"}}"}} 2>&1 | tee /tmp/pingpong_64_raw.txt || echo '[WARNING] pingpong client exited with error'; else echo '[SKIP]' > /tmp/pingpong_64_raw.txt; fi"
      ]
    },
    {
      "id": "03-run-pingpong-1k",
      "name": "Run ib_write_lat client (size=1024)",
      "commands": [
        "echo '[INFO] Starting ib_write_lat client (size=1024) connecting to {{"{{"}}PEER_IP{{"}}"}}...'",
        "sleep 3",
        "if command -v ib_write_lat >/dev/null 2>&1 && [ -n '{{"{{"}}PEER_IP{{"}}"}}' ]; then ib_write_lat -d rdmap49s0 -s 1024 -F {{"{{"}}PEER_IP{{"}}"}} 2>&1 | tee /tmp/pingpong_1k_raw.txt || echo '[WARNING] pingpong client exited with error'; else echo '[SKIP]' > /tmp/pingpong_1k_raw.txt; fi"
      ]
    },
    {
      "id": "04-run-pingpong-64k",
      "name": "Run ib_write_lat client (size=65536)",
      "commands": [
        "echo '[INFO] Starting ib_write_lat client (size=65536) connecting to {{"{{"}}PEER_IP{{"}}"}}...'",
        "sleep 3",
        "if command -v ib_write_lat >/dev/null 2>&1 && [ -n '{{"{{"}}PEER_IP{{"}}"}}' ]; then ib_write_lat -d rdmap49s0 -s65536 {{"{{"}}PEER_IP{{"}}"}} 2>&1 | tee /tmp/pingpong_64k_raw.txt || echo '[WARNING] pingpong client exited with error'; else echo '[SKIP]' > /tmp/pingpong_64k_raw.txt; fi"
      ]
    },
    {
      "id": "05-run-pingpong-1m",
      "name": "Run ib_write_lat client (size=1048576)",
      "commands": [
        "echo '[INFO] Starting ib_write_lat client (size=1048576) connecting to {{"{{"}}PEER_IP{{"}}"}}...'",
        "sleep 3",
        "if command -v ib_write_lat >/dev/null 2>&1 && [ -n '{{"{{"}}PEER_IP{{"}}"}}' ]; then ib_write_lat -d rdmap49s0 -s1048576 {{"{{"}}PEER_IP{{"}}"}} 2>&1 | tee /tmp/pingpong_1m_raw.txt || echo '[WARNING] pingpong client exited with error'; else echo '[SKIP]' > /tmp/pingpong_1m_raw.txt; fi"
      ]
    },
{% endif %}
    {
      "id": "06-collect-results",
      "name": "Collect latency results into JSON",
      "commands": [
        "echo '[INFO] Collecting results into {{"{{"}}OUTPUT_FILE{{"}}"}}...'",
        "python3 /tmp/scripts/collect_ib_write_lat.py --pattern-id {{"{{"}}PATTERN_ID{{"}}"}} --phase {{"{{"}}PHASE{{"}}"}} --timestamp {{"{{"}}TIMESTAMP{{"}}"}} --output {{"{{"}}OUTPUT_FILE{{"}}"}} --node-role {{"{{"}}NODE_ROLE{{"}}"}} --peer-ip '{{"{{"}}PEER_IP{{"}}"}}'",
        "echo '[OK] ib_write_lat baseline measurement complete'"
      ]
    }
  ]
}
