{
  "name": "Low-Level: {{ tool }} {{ provider|upper }} - {{ message_sizes|join(', ') }}",
  "description": "EFA basic latency measurement using {{ tool }} with provider={{ provider }}",
  "variables": {
    "OUTPUT_DIR": "/tmp/low-level-results",
    "OUTPUT_FILE": "/tmp/low-level-results/{{ pattern_id }}.json",
    "NODE1_PRIVATE": "{% raw %}{{NODE1_PRIVATE}}{% endraw %}"
  },
  "tasks": [
    {
      "id": "01-create-output-dir",
      "name": "Create Output Directory",
      "description": "Create directory for measurement results",
      "skip_if": "test -d /tmp/low-level-results",
      "commands": [
        "mkdir -p /tmp/low-level-results",
        "echo '[OK] Output directory created'"
      ]
    },
    {
      "id": "02-verify-efa-device",
      "name": "Verify EFA Device",
      "description": "Verify EFA device is available",
      "commands": [
        "fi_info -p {{ provider }} -t FI_EP_RDM 2>/dev/null | head -5 || { echo '[ERROR] EFA device not found'; exit 1; }",
        "echo '[OK] EFA device available'"
      ]
    },
    {
      "id": "03-run-measurement",
      "name": "Run {{ tool }} Measurement ({{ message_sizes|length }} sizes)",
      "description": "Run {{ tool }} server+client pairs for each message size sequentially",
      "commands": [
        "if [ -z \"$NODE1_PRIVATE\" ]; then echo '[ERROR] NODE1_PRIVATE not set'; exit 1; fi",
        "RESULTS_JSON='{\"tool\": \"{{ tool }}\", \"provider\": \"{{ provider }}\", \"pattern_id\": \"{{ pattern_id }}\", \"phase\": \"{{ phase | default('low-level') }}\", \"model\": \"{{ infrastructure.model | default('') }}\", \"model_size\": \"{{ infrastructure.model_size | default('') }}\", \"instance_type\": \"{{ infrastructure.instance_type | default('') }}\", \"timestamp\": \"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'\", \"results\": ['",
        "FIRST=true",
{% for size in message_sizes %}
        "echo '[INFO] === Message size: {{ size }} ({{ loop.index }}/{{ message_sizes|length }}) ==='",
        "echo '[INFO] Starting server for size {{ size }}...'",
        "timeout 60 {{ tool }} -p {{ provider }}{% if size != 'default' %} -S {{ size }}{% endif %} -I {{ iterations }} > {% raw %}{{OUTPUT_DIR}}{% endraw %}/{{ pattern_id }}_server_{{ size }}.log 2>&1 &",
        "SERVER_PID=$!",
        "sleep 3",
        "echo '[INFO] Running client for size {{ size }}...'",
        "RAW_OUTPUT=$(timeout 120 {{ tool }} -p {{ provider }}{% if size != 'default' %} -S {{ size }}{% endif %} -I {{ iterations }} $NODE1_PRIVATE 2>&1) || true",
        "echo \"$RAW_OUTPUT\"",
        "wait $SERVER_PID 2>/dev/null || true",
        "LATENCY=$(echo \"$RAW_OUTPUT\" | grep -E '^[0-9]' | tail -1 | awk '{print $NF}' || echo '0')",
        "BANDWIDTH=$(echo \"$RAW_OUTPUT\" | grep -E '^[0-9]' | tail -1 | awk '{print $(NF-1)}' || echo '0')",
        "if [ \"$FIRST\" = \"true\" ]; then FIRST=false; else RESULTS_JSON=\"$RESULTS_JSON,\"; fi",
        "RESULTS_JSON=\"$RESULTS_JSON{\\\"message_size\\\": \\\"{{ size }}\\\", \\\"latency_us\\\": ${LATENCY:-0}, \\\"bandwidth_mbps\\\": ${BANDWIDTH:-0}}\"",
        "echo '[OK] Size {{ size }} complete'",
        "sleep 1",
{% endfor %}
        "RESULTS_JSON=\"$RESULTS_JSON]}\"",
        "echo \"$RESULTS_JSON\" | python3 -m json.tool > {% raw %}{{OUTPUT_FILE}}{% endraw %}",
        "echo '[OK] Results saved to {% raw %}{{OUTPUT_FILE}}{% endraw %}'",
        "cat {% raw %}{{OUTPUT_FILE}}{% endraw %}"
      ]
    },
    {
      "id": "04-collect-results",
      "name": "Collect Results",
      "description": "Display measurement results",
      "commands": [
        "echo '--- {{ tool }} Results ---'",
        "cat {% raw %}{{OUTPUT_FILE}}{% endraw %} 2>/dev/null || echo '[INFO] Results file not found'",
        "echo '--- End Results ---'"
      ]
    }
  ]
}
