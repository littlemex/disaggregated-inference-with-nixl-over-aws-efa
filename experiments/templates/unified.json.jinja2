{
  "name": "Phase {{ phase }}: Unified - {{ prompt_tokens }} tokens - c={{ concurrency }}",
  "description": "Unified mode, {{ infrastructure.instance_type }} x {{ infrastructure.node_count }} nodes, {{ prompt_tokens }} tokens, c={{ concurrency }}, Prefix Cache {{ 'ON' if prefix_cache else 'OFF' }}",
  "variables": {
    "VENV_PATH": "{{ infrastructure.venv_path }}",
    "MODEL": "{{ infrastructure.model }}",
    "PORT": "8100",
    "BENCHMARK_SCRIPT": "/tmp/benchmark_common.py",
    "OUTPUT_FILE": "/tmp/results/{{ pattern_id }}.json",
    "LOG_FILE": "/tmp/vllm_unified_{{ pattern_id }}.log",
    "PID_FILE": "/tmp/vllm_unified_{{ pattern_id }}.pid",
    "PROMPT_TOKENS": "{{ prompt_tokens }}",
    "MAX_TOKENS": "{{ max_tokens }}",
    "CONCURRENCY": "{{ concurrency }}",
    "WARMUP_ITERATIONS": "{{ warmup_iterations }}",
    "NUM_ITERATIONS": "{{ measurement_iterations }}",
    "GPU_MEMORY_UTIL": "{{ gpu_memory_utilization }}",
    "MAX_BATCHED_TOKENS": "{{ max_num_batched_tokens }}",
    "MAX_MODEL_LEN": "{{ max_model_len }}",
{% if infrastructure.tp_size is defined and infrastructure.tp_size > 1 %}
    "TP_SIZE": "{{ infrastructure.tp_size }}",
{% endif %}
    "PHASE": "{{ phase }}"
  },
  "tasks": [
    {
      "id": "01-verify-benchmark-script",
      "name": "Verify Benchmark Script",
      "description": "Verify benchmark script exists",
      "commands": [
        "if [ ! -f {{"{{"}}BENCHMARK_SCRIPT{{"}}"}} ]; then echo '[ERROR] Benchmark script not found: {{"{{"}}BENCHMARK_SCRIPT{{"}}"}}'; exit 1; fi",
        "echo '[OK] Benchmark script found'"
      ]
    },
    {
      "id": "02-cleanup-gpu",
      "name": "Cleanup GPU Memory",
      "description": "Terminate existing vLLM processes and ensure GPU memory is released",
      "commands": [
        "echo '[INFO] Cleaning up GPU memory and shared memory...'",
        "sudo rm -f /dev/shm/psm_* /dev/shm/shm_* /dev/shm/VLLM_* 2>/dev/null || true",
        "sudo pkill -TERM -f 'vllm.entrypoints' 2>/dev/null || true",
        "sleep 5",
        "sudo pkill -9 -f 'vllm.entrypoints' 2>/dev/null || true",
        "sudo pkill -9 -f 'ray::' 2>/dev/null || true",
        "sleep 2",
        "nvidia-smi --query-compute-apps=pid --format=csv,noheader 2>/dev/null | while read pid; do [ -n \"$pid\" ] && sudo kill -9 $pid 2>/dev/null || true; done",
        "echo '[INFO] Waiting for GPU memory to be released (max 60 seconds)...'",
        "for i in $(seq 1 12); do MAX_MEM=$(nvidia-smi --query-gpu=memory.used --format=csv,noheader,nounits 2>/dev/null | sort -rn | head -1); if [ -z \"$MAX_MEM\" ] || [ \"$MAX_MEM\" -lt 1000 ]; then echo '[OK] GPU memory released'; break; fi; [ $((i % 3)) -eq 0 ] && echo '[INFO] Waiting... GPU memory: '$MAX_MEM' MiB ('$i'/12)'; sleep 5; done",
        "nvidia-smi --query-gpu=index,memory.used --format=csv,noheader || true"
      ]
    },
    {
      "id": "03-start-unified",
      "name": "Start Unified vLLM ({{ 'Prefix Cache ON' if prefix_cache else 'Prefix Cache OFF' }})",
      "description": "Start Unified server (gpu={{ gpu_memory_utilization }}, max_model_len={{ max_model_len }})",
      "skip_if": "pgrep -f 'vllm.entrypoints.openai.api_server.*--max-model-len {{"{{"}}MAX_MODEL_LEN{{"}}"}}' > /dev/null && curl -s http://localhost:{{"{{"}}PORT{{"}}"}}/health | grep -q ok",
      "commands": [
{% if infrastructure.tp_size is defined and infrastructure.tp_size > 1 %}
        "export NCCL_DEBUG=INFO",
        "export NCCL_IB_DISABLE=0",
{% endif %}
        "export VLLM_ALLOW_LONG_MAX_MODEL_LEN=1",
        "nohup python3 -m vllm.entrypoints.openai.api_server --model {{"{{"}}MODEL{{"}}"}} --disable-log-requests --trust-remote-code --port {{"{{"}}PORT{{"}}"}} {% if infrastructure.tp_size is defined and infrastructure.tp_size > 1 %}--tensor-parallel-size {{"{{"}}TP_SIZE{{"}}"}} {% endif %}--gpu-memory-utilization {{"{{"}}GPU_MEMORY_UTIL{{"}}"}} --max-num-batched-tokens {{"{{"}}MAX_BATCHED_TOKENS{{"}}"}} --enable-chunked-prefill --enforce-eager --max-model-len {{"{{"}}MAX_MODEL_LEN{{"}}"}} {{ '--enable-prefix-caching' if prefix_cache else '--no-enable-prefix-caching' }} > {{"{{"}}LOG_FILE{{"}}"}} 2>&1 &",
        "echo $! > {{"{{"}}PID_FILE{{"}}"}}",
        "echo '[OK] Unified server started ({{ 'Prefix Cache ON' if prefix_cache else 'Prefix Cache OFF' }})'"
      ]
    },
    {
      "id": "04-wait-initialization",
      "name": "Wait for Initialization",
      "description": "Wait for model initialization",
      "commands": [
        "echo '[INFO] Waiting {{ init_wait_seconds }} seconds for initialization...'",
        "sleep {{ init_wait_seconds }}"
      ]
    },
    {
      "id": "05-health-check",
      "name": "Health Check (OOM Detection)",
      "description": "Verify vLLM server is ready with OOM/error early detection",
      "commands": [
        "HEALTH_OK=false; OOM_DETECTED=false; ERROR_DETECTED=false; HEALTH_TIMEOUT={{ health_check_timeout | default(300) }}; for i in $(seq 1 $HEALTH_TIMEOUT); do HTTP_CODE=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:{{"{{"}}PORT{{"}}"}}/health 2>/dev/null || echo '000'); if [ \"$HTTP_CODE\" = \"200\" ]; then echo \"[OK] vLLM server ready (took $i seconds)\"; HEALTH_OK=true; break; fi; if [ $((i % 10)) -eq 0 ]; then if grep -qE 'torch\\.OutOfMemoryError|CUDA out of memory|torch\\.cuda\\.OutOfMemoryError|Cannot allocate memory|KV cache is needed.*larger than.*available' {{"{{"}}LOG_FILE{{"}}"}} 2>/dev/null; then echo '[ERROR] OOM detected in vLLM logs'; OOM_DETECTED=true; break; fi; if grep -qE 'ValueError.*max seq len|RuntimeError.*CUDA|Traceback \\(most recent call last\\)' {{"{{"}}LOG_FILE{{"}}"}} 2>/dev/null; then echo '[ERROR] vLLM startup error detected'; ERROR_DETECTED=true; break; fi; fi; if [ $((i % 30)) -eq 0 ]; then LAST_LOG=$(tail -1 {{"{{"}}LOG_FILE{{"}}"}} 2>/dev/null || echo 'no log'); echo \"[INFO] Waiting... ($i/$HEALTH_TIMEOUT) - Last log: $LAST_LOG\"; fi; sleep 1; done; if [ \"$OOM_DETECTED\" = \"true\" ]; then echo '[FATAL] VRAM OOM - this pattern requires more GPU memory than available'; echo '--- Last 30 lines of log ---'; tail -30 {{"{{"}}LOG_FILE{{"}}"}};  echo '--- End of log ---'; false; elif [ \"$ERROR_DETECTED\" = \"true\" ]; then echo '[FATAL] vLLM startup error'; echo '--- Last 30 lines of log ---'; tail -30 {{"{{"}}LOG_FILE{{"}}"}};  echo '--- End of log ---'; false; elif [ \"$HEALTH_OK\" = \"false\" ]; then echo \"[ERROR] Health check timeout ($HEALTH_TIMEOUT seconds)\"; echo '--- Last 50 lines of log ---'; tail -50 {{"{{"}}LOG_FILE{{"}}"}};  echo '--- End of log ---'; false; fi"
      ]
    },
{% if measurement_type == 'online' %}
    {
      "id": "06-run-benchmark",
      "name": "Run Benchmark ({{ prompt_tokens }} tokens, c={{ concurrency }})",
      "description": "Run benchmark (warmup={{ warmup_iterations }}, measurement={{ measurement_iterations }}, c={{ concurrency }})",
      "skip_if": "test -s {{"{{"}}OUTPUT_FILE{{"}}"}} && python3 -c \"import json; json.load(open('{{"{{"}}OUTPUT_FILE{{"}}"}}'))\" 2>/dev/null && echo '[SKIP] Benchmark already completed: {{"{{"}}OUTPUT_FILE{{"}}"}}'",
      "commands": [
        "sudo mkdir -p /tmp/results && sudo chown ubuntu:ubuntu /tmp/results",
        "sudo -u ubuntu env MLFLOW_EXPERIMENT_TIMESTAMP=\"${MLFLOW_EXPERIMENT_TIMESTAMP:-}\" python3 {{"{{"}}BENCHMARK_SCRIPT{{"}}"}} --measurement-type online --url http://localhost:{{"{{"}}PORT{{"}}"}} --model {{"{{"}}MODEL{{"}}"}} --mode unified --backend none --prompt-tokens {{"{{"}}PROMPT_TOKENS{{"}}"}} --max-tokens {{"{{"}}MAX_TOKENS{{"}}"}} --warmup-iterations {{"{{"}}WARMUP_ITERATIONS{{"}}"}} --num-iterations {{"{{"}}NUM_ITERATIONS{{"}}"}} --concurrency {{"{{"}}CONCURRENCY{{"}}"}} --prefix-cache {{ 'enabled' if prefix_cache else 'disabled' }} --output {{"{{"}}OUTPUT_FILE{{"}}"}} --mlflow-tracking-uri ${MLFLOW_TRACKING_ARN} --mlflow-experiment-name nixl-efa-phase1 --phase {{"{{"}}PHASE{{"}}"}} --layer '{{ layer_name }}' --priority '{{ layer_priority }}' --tags 'phase={{ phase }}{% if infrastructure.tp_size is defined %},tp_size={{ infrastructure.tp_size }}{% endif %},instance={{ infrastructure.instance_type }}' --mlflow-run-name {{ pattern_id }}-$(date +%Y%m%d-%H%M%S)",
        "echo '[OK] Benchmark complete: {{"{{"}}OUTPUT_FILE{{"}}"}}'"
      ]
    }
{% else %}
    {
      "id": "06-run-benchmark-offline",
      "name": "Run Benchmark (Offline, {{ prompt_tokens }} tokens)",
      "description": "Run offline benchmark (Python API direct)",
      "skip_if": "test -s {{"{{"}}OUTPUT_FILE{{"}}"}} && python3 -c \"import json; json.load(open('{{"{{"}}OUTPUT_FILE{{"}}"}}'))\" 2>/dev/null && echo '[SKIP] Benchmark already completed: {{"{{"}}OUTPUT_FILE{{"}}"}}'",
      "commands": [
        "sudo mkdir -p /tmp/results && sudo chown ubuntu:ubuntu /tmp/results",
        "sudo -u ubuntu python3 {{"{{"}}BENCHMARK_SCRIPT{{"}}"}} --measurement-type offline --model {{"{{"}}MODEL{{"}}"}} --prompt-tokens {{"{{"}}PROMPT_TOKENS{{"}}"}} --max-tokens {{"{{"}}MAX_TOKENS{{"}}"}} --num-iterations {{"{{"}}NUM_ITERATIONS{{"}}"}} --prefix-cache {{ 'enabled' if prefix_cache else 'disabled' }} --output {{"{{"}}OUTPUT_FILE{{"}}"}} --mlflow-tracking-uri ${MLFLOW_TRACKING_ARN} --mlflow-experiment-name nixl-efa-phase1 --phase {{"{{"}}PHASE{{"}}"}} --mlflow-run-name {{ pattern_id }}-$(date +%Y%m%d-%H%M%S)",
        "echo '[OK] Benchmark complete: {{"{{"}}OUTPUT_FILE{{"}}"}}'"
      ]
    }
{% endif %},
    {
      "id": "07-collect-results",
      "name": "Collect Results",
      "description": "Display results JSON",
      "commands": [
        "echo '--- Results Summary ---'",
        "cat {{"{{"}}OUTPUT_FILE{{"}}"}} | head -30 || echo '[INFO] Results file not found'",
        "echo '--- End Results ---'"
      ]
    },
    {
      "id": "99-cleanup-after-measurement",
      "name": "Cleanup After Measurement",
      "description": "Terminate vLLM processes and ensure GPU memory is released",
      "commands": [
        "echo '[INFO] Cleaning up GPU memory and shared memory...'",
        "sudo rm -f /dev/shm/psm_* /dev/shm/shm_* /dev/shm/VLLM_* 2>/dev/null || true",
        "sudo pkill -TERM -f 'vllm.entrypoints' 2>/dev/null || true",
        "sleep 5",
        "sudo pkill -9 -f 'vllm.entrypoints' 2>/dev/null || true",
        "sudo pkill -9 -f 'ray::' 2>/dev/null || true",
        "sleep 2",
        "nvidia-smi --query-compute-apps=pid --format=csv,noheader 2>/dev/null | while read pid; do [ -n \"$pid\" ] && sudo kill -9 $pid 2>/dev/null || true; done",
        "echo '[INFO] Waiting for GPU memory to be released (max 60 seconds)...'",
        "for i in $(seq 1 12); do MAX_MEM=$(nvidia-smi --query-gpu=memory.used --format=csv,noheader,nounits 2>/dev/null | sort -rn | head -1); if [ -z \"$MAX_MEM\" ] || [ \"$MAX_MEM\" -lt 1000 ]; then echo '[OK] GPU memory released'; break; fi; [ $((i % 3)) -eq 0 ] && echo '[INFO] Waiting... GPU memory: '$MAX_MEM' MiB ('$i'/12)'; sleep 5; done",
        "nvidia-smi --query-gpu=index,memory.used --format=csv,noheader || true",
        "echo '[OK] Cleanup complete'"
      ]
    }
  ]
}
